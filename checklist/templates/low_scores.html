{% extends "base.html" %}

{% block title %}Низкие баллы (0-1){% endblock %}

{% block extra_head %}
<style>
  /* Umumiy dizayn */
  body { font-family: Arial, sans-serif; background:#f4f6f7; padding:20px; margin: 0; }
  h2 { text-align: center; color: #333; margin-bottom: 20px; }

  /* Card va Filial ma'lumotlari */
  .card { 
    background:#fff; 
    padding:16px; 
    border-radius:12px; 
    margin-bottom:16px; 
    box-shadow:0 4px 12px rgba(0,0,0,.08); 
  }
  .card-info {
    font-size: 14px;
    line-height: 1.6;
    margin-bottom: 10px;
    color: #555;
  }

  /* Filtrlar qismi */
  .filters { 
    display: flex; 
    gap: 10px; 
    flex-wrap: wrap; 
    margin-bottom: 20px; 
    background: #fff;
    padding: 15px;
    border-radius: 12px;
  }
  .filters select, .filters input[type="date"] { 
    flex: 1 1 120px; /* Mobilda moslashuvchan kenglik */
    padding: 10px; 
    border-radius: 8px; 
    border: 1px solid #ccc; 
    font-size: 14px;
  }
  .btn { 
    padding: 10px 20px; 
    border: none; 
    border-radius: 8px; 
    background: #2f7df6; 
    color: #fff; 
    cursor: pointer; 
    font-weight: bold;
    flex: 1 1 100%; /* Mobilda tugma to'liq kenglikda */
  }

  /* Jadval sig'ishi uchun qat'iy qoidalar */
  .table-wrap { 
    width: 100%; 
    overflow-x: auto; 
    -webkit-overflow-scrolling: touch; 
  }
  table { 
    width: 100%; 
    border-collapse: collapse; 
    margin-top: 10px; 
    min-width: 320px; /* Telefon kengligidan kichik bo'lmasligi uchun */
  }
  th, td { 
    border: 1px solid #eee; 
    padding: 8px; 
    vertical-align: middle; 
    font-size: 13px;
    text-align: center;
  }
  th { background:#e9f2ff; color: #333; }
  
  /* Band nomi chapga tekislansin */
  td:first-child, th:first-child { text-align: left; }

  /* Ballar ranglari */
  .s0 { background:#ffdddd; font-weight:700; color: #d9534f; }
  .s1 { background:#fff3cd; font-weight:700; color: #8a6d3b; }
  
  /* Rasmlar */
  .img { 
    max-width: 70px; 
    max-height: 90px; 
    border: 1px solid #ddd; 
    border-radius: 6px; 
    object-fit: cover;
  }

  /* ✅ Mobile Tweaklar (Struktura o'zgarmaydi) */
  @media (max-width: 600px) {
    body { padding: 10px; }
    h2 { font-size: 1.3rem; }
    .card { padding: 12px; }
    
    /* Filial ma'lumotlarini ustma-ust qilish */
    .card-info b { display: inline-block; margin-bottom: 2px; }
    
    th, td { padding: 6px 4px; font-size: 12px; }
    
    .img { max-width: 60px; max-height: 80px; }

    /* Filtrlarni to'liq kenglikka yoyish */
    .filters select, .filters input[type="date"] {
      flex: 1 1 100%;
    }
  }


.table-wrap {
    /* Jadvalning pastidan qo'shimcha joy ochadi */
    padding-bottom: 50px; 
}


.img { 
    cursor: zoom-in; 
    transition: transform 0.2s; 
}
.img:hover { 
    transform: scale(1.05); /* Bosishdan oldin biroz kattalashadi */
}

/* Modal ochilganda markazda turishi uchun */
#imageModal {
    display: none; /* Standart holatda yashirin */
    display: flex; /* JavaScript orqali block emas, flex qilinadi */
}
</style>
{% endblock %}

{% block content %}

<h2>Низкие баллы (0 va 1)</h2>

<form class="filters" method="get">
  <select name="filial">
    <option value="all">Все филиалы</option>
    {% for f in all_filials %}
      <option value="{{ f }}" {% if selected_filial == f %}selected{% endif %}>{{ f }}</option>
    {% endfor %}
  </select>

  <select name="score">
    <option value="all" {% if selected_score == "all" %}selected{% endif %}>0 и 1</option>
    <option value="0" {% if selected_score == "0" %}selected{% endif %}>Только 0</option>
    <option value="1" {% if selected_score == "1" %}selected{% endif %}>Только 1</option>
  </select>

  <input type="date" name="from" value="{{ date_from }}">
  <input type="date" name="to" value="{{ date_to }}">

  <button class="btn" type="submit">Фильтр</button>
</form>

{% for a in audits %}
  {% if a.low_details %}
    <div class="card">
      <div class="card-info">
        Филиал: <b>{{ a.filial_nomi }}</b> |
        Аудитор: <b>{{ a.auditor|default:"-" }}</b> |
        Дата: <b>{{ a.created_at|date:"d-m-Y H:i" }}</b>
      </div>

      <div class="table-wrap">
        <table >
          <thead>
            <tr>
              <th>Пункт</th>
              <th style="width:70px;">Баллы</th>
              <th style="width:140px;">Изображение</th>
            </tr>
          </thead>
          <tbody>
            {% for d in a.low_details %}
              <tr>
                <td>{{ d.band_id }}</td>
                <td class="{% if d.score == 0 %}s0{% else %}s1{% endif %}">{{ d.score }}</td>
                <td>
                  {% if d.image %}
                    <img class="img" src="{{ d.image.url }}" />
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}
{% endfor %}
<div id="imageModal" onclick="this.style.display='none'" style="display:none; position:fixed; z-index:10000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.9); cursor:zoom-out; align-items:center; justify-content:center;">
    <img id="modalImg" style="max-width:95%; max-height:95%; border:3px solid white; border-radius:10px;">
</div>
<script>
    // Sahifadagi barcha "img" klassiga ega rasmlarni topamiz
    document.querySelectorAll('.img').forEach(image => {
        image.onclick = function() {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImg');
            
            modal.style.display = "flex"; // Yashirin oynani ko'rsatish
            modalImg.src = this.src;      // Bosilgan rasm manzilini o'rnatish
        };
    });
</script>
{% endblock %}
